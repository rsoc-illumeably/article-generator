# Minimal nginx config for the article-generator production stack.
# Responsibilities:
#   1. Redirect plain HTTP (port 80) to HTTPS (port 443).
#   2. Terminate SSL using the self-signed cert generated by setup_ssl.sh.
#   3. Forward all requests to the FastAPI app container.
#
# Used only in docker-compose.prod.yml.
# Not needed for local development.

events {
    # Default worker connection limit — more than enough for a personal tool.
    worker_connections 1024;
}

http {
    # --------------------------------------------------------------------------
    # HTTP → HTTPS redirect
    # Catches all plain HTTP traffic and issues a permanent redirect to HTTPS.
    # --------------------------------------------------------------------------
    server {
        listen 80;

        # 301 redirect everything to HTTPS, preserving the request URI.
        return 301 https://$host$request_uri;
    }

    # --------------------------------------------------------------------------
    # HTTPS server
    # Terminates SSL and proxies all requests to the FastAPI app.
    # --------------------------------------------------------------------------
    server {
        listen 443 ssl;

        # Self-signed certificate and private key generated by setup_ssl.sh.
        # Mounted into the container via docker-compose.prod.yml.
        ssl_certificate     /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;

        # Disallow old, insecure TLS versions.
        ssl_protocols TLSv1.2 TLSv1.3;

        # Proxy all requests to the FastAPI app.
        # "app" resolves to the app container via Docker's internal DNS.
        location / {
            proxy_pass         http://app:8000;

            # Pass the original Host header so FastAPI sees the right hostname.
            proxy_set_header   Host              $host;

            # Pass the real client IP for logging purposes.
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;

            # Tell the app it was reached over HTTPS.
            proxy_set_header   X-Forwarded-Proto $scheme;
        }
    }
}
